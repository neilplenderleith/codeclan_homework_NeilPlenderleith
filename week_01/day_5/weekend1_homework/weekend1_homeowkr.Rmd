---
title: "R Notebook"
output: html_notebook
---

# Load Libraries and Data

```{r}
library(tidyverse)
library(skimr)
library(janitor)
library(lubridate)
library(anytime)
library(ggplot2)
books <- read.csv("books.csv")
```

# A first look and initial tests on books.csv

```{r}
#I used these 3 functions to get an initial idea of the dataset
# glimpse(books)
# summary(books)
# skim(books)


# Lets do a count of N/A and missing values etc

books %>% 
  summarise(across(.fns = ~ sum(is.na(.x)))) 
# this counts N/A values across all columns

books %>% 
  summarise(across(.fns = ~ sum(is_empty(.x)))) 
# this counts empty values in columns

books %>% 
  summarise(across(.fns = ~ sum(.x == "")))
# This counts empty strings across all columns

books %>% 
  summarise(across(.fns = ~ sum(.x == 0, 
                                na.rm = T)))
#This counts any 0 values across all columns



```

# First thoughts about the Data

Looks like num_pages and avg_rating should be numeric rather than character.

Column names look ok - all self-explanatory , all in snake_case and no capitals.

There are only 8 N/A values in the whole dataset.

Since its 11131 rows lets consider dropping the 8 N/A rows - turns out after
a look that these are in 4 otherwise useless rows - lets drop.

There are quite a few 0 values in the data:
num_pages has 76 "0" values - perhaps change these to the mean.
ratings_count has 80 "0" values - this is fine as some books have no reviews.
text_review_count also fine to have 0 values.
publication date has 1 "0" value.

# Clean data

```{r}

# here we drop NA's, clean out a couple of random rows
# change numpages to integer from character
# change average rating to numeric
# impute into num_pages the mean of num_pages column for 0 values

books_clean <- books %>% 
  drop_na() %>% # Lets drop the 4 N/A rows
  filter(!num_pages %in% c("eng", "en-US")) %>% 
  mutate(num_pages = as.integer(num_pages),
         average_rating = as.numeric(average_rating)) %>% 
  mutate(num_pages = if_else(num_pages == 0, 
                             as.integer(mean(num_pages)), 
                             num_pages))



books_clean %>%  # quick check to see "0"s have gone (changed to mean)
summarise(across(.cols = num_pages, .fns = ~ sum(.x == 0, 
                                na.rm = T)))

# OK we can live with this data for the moment lets start somes tasks

```



# 1. Most Prolific Author - TOP 10

```{r}

books_clean %>% 
  group_by(authors) %>% 
  summarise(books_authored = n()) %>% 
  slice_max(books_authored, n = 10)

# Turns out it returns a top-13 as the 10th place is tied 4 ways
# We will allow this but could change it with the "with_ties" argument

```


# 2. TOP 10 authors by mean of their average reviews, at least 3 books written

For future reference this function:
make 2 columns: number of books written per author
                average author reviews from all of their books
filters for those authors who have written 3 or more books
takes the top 10 then selects the authors and their average reviews



```{r}

top_10_reviewed_authors <- books_clean %>% 
  group_by(authors) %>% 
  summarise(books_authored = n(), 
         author_average_reviews = round(mean(average_rating), 2)) %>% 
  filter(books_authored > 3) %>% 
  slice_max(author_average_reviews, n = 10) %>% 
  select(authors, author_average_reviews)
  
  top_10_reviewed_authors

```

# 3. Which language used? Sort the 10 most popular languages and list by
descending percentage

```{r}

languages_percent <- books_clean %>% 
  count(language_code) %>% 
  arrange(desc(n)) %>% 
  mutate(percentage_language = round((n/sum(n))*100, 2)) %>% 
  slice_max(percentage_language, n = 10) %>% 
  select(language_code, percentage_language)

languages_percent

```

# 4. Best years for book writing by average review 

anydate() and anytime() very useful functions for turning character dates into <date>
from the package "anytime"

First we add columns which clean up the publisher date from a character to a <date>
We pull the year from this value to another column 
Then we summarise calculating average ratings per year published and
number of ratings per year. We then filter for only those with more than 4 ratings per year
and return the top 10 years.


```{r}




books_date <- books_clean %>% 
  mutate(pub_date = anydate(publication_date), 
         year_written = year(pub_date)) %>% 
  group_by(year_written) %>% 
  summarise(rating_per_year = round(mean(average_rating), 2), no_ratings_per_year = n()) %>% 
  filter(no_ratings_per_year >= 4) %>% 
  slice_max(rating_per_year, n = 10)
  books_date
  
  # I had to have a wee look at this on a v simple graph 
  # ungroup()
  #  ggplot(books_date, aes(x = year_written, y = rating_per_year)) +
  #   geom_point() + 
  #   geom_smooth()
  
```

# 5. Multiple Authors

How many books are authored by multiple authors? Looking at the data multiple authors are separated by "/" character so if we check for that in each author and count it should give us the data.

Here we use the base R function grepl which tests if a string is contained in a vector and returns T/F

```{r}
# Summarise by authors containing a "/" symbol (these should be multi-authored)
# then count each side and do some tidying up

book_solo_yn <- books_clean %>% 
  summarise(multi_author = grepl("/", books_clean$authors, fixed = T)) %>% 
  count(multi_author) %>% 
  mutate(multi_authored = if_else(multi_author == F, "solo", "multiple authors"), .keep = "unused")


book_solo_yn


```

# 6. More multiple authors

I'm not overly happy with #5 above. Lets redo it and check to see if average rating 
of multi authored books is higher or lower than solo authors on average.

```{r}
avg_rating_solo <- books_clean %>% 
  mutate(solo_author = grepl("/", books_clean$authors, fixed = T)) %>% 
  filter(solo_author == F) %>% 
  summarise(avg_rating_solo = mean(average_rating), count = n())
avg_rating_solo

avg_rating_multi <- books_clean %>% 
  mutate(solo_author = grepl("/", books_clean$authors, fixed = T)) %>% 
  filter(solo_author == T) %>% 
  summarise(avg_rating_multi = mean(average_rating), count = n())
avg_rating_multi

# 6561 solo written books, 4562 multiple authored books
# multi authored books win 3.96 to 3.91 though theres not much in it
```


# 7. Most well reviewed publisher? most books published by publisher

```{r}

# counts books by publisher, assigns an average review for each publisher
# then filters for books > 3 and arranges by number of books or avg review

top_publishers <- books_clean %>% 
  group_by(publisher) %>% 
  summarise(books_by_publisher = n(), 
            publisher_average_reviews = round(mean(average_rating), 2)) %>% 
  filter(books_by_publisher > 3) %>% 
  #arrange(desc(publisher_average_reviews))
  arrange(desc(books_by_publisher))
  top_publishers

```


# 8. How about a random specific query. 

Like find the most text-reviewed books in the 90's by the publisher Vintage?

```{r}

books_clean %>% 
  mutate(pub_date = anydate(publication_date), 
         year_written = year(pub_date)) %>% 
  filter(year_written >= 1990 &
         year_written <2000 &
           publisher == "Vintage") %>% 
  select(title, text_reviews_count) %>% 
  slice_max(text_reviews_count, n = 20)
  

```


# 9.

















# Do authors always go with the same publisher or do they move around publishers

```{r}
# 
# books_clean %>% 
#   group_by(authors, publisher) %>% 
#   summarise(publisher_count = sum(n()))
#   
    # unique() %>%
# group_by(authors) %>%
# summarize(vis_count = n())
  
  #   select(authors, publisher) %>% 
#   group_by(authors) %>% 
# distinct()
#   


```

